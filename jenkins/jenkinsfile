//ci pipeline

pipeline {
    agent { label 'jenkins-agent' } 

    environment {
        IMAGE_NAME = "myapp"                     
        IMAGE_TAG  = "latest"                    
        GCP_PROJECT = "prod-project-477306"    
        GCR_REGION = "us"             
        GCR_IMAGE = "${GCR_REGION}.gcr.io/${GCP_PROJECT}/${IMAGE_NAME}:${IMAGE_TAG}"
    }

    stages {
        stage('Checkout Code') {
            steps {
                git branch: 'main', url: 'https://github.com/abhizarkar7551/dev.git'
            }
        }

        stage('Build Docker Image') {
            steps {
                script {
                    docker.build("${IMAGE_NAME}:${IMAGE_TAG}", "./app")
                }
            }
        }

        stage('Push to GCR') {
            steps {
                withCredentials([file(credentialsId: 'my-global-sa', variable: 'GCP_KEY')]) {
                    script {
                        sh "gcloud auth activate-service-account --key-file=${GCP_KEY}"
                        sh "gcloud auth configure-docker --quiet"
                        sh "docker tag ${IMAGE_NAME}:${IMAGE_TAG} ${GCR_IMAGE}"
                        sh "docker push ${GCR_IMAGE}"
                    }
                }
            }
        }
    }


    post {
        success {
            echo "CI pipeline succeeded. Triggering CD pipeline..."
            build job: 'cd-pipeline', wait: false
        }
        failure {
            echo "CI pipeline failed. CD pipeline will NOT run."
        }
    }

}


