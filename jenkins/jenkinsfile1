pipeline {
    agent { label 'jenkins-agent' }  // same agent as CI

    environment {
        GCP_PROJECT     = "prod-project-477306"
        GKE_CLUSTER     = "gke-standard-cluster"
        GKE_REGION      = "us-central1-a"
        DEPLOYMENT_FILE = "k8s/" // point to actual deployment YAML
        IMAGE_NAME      = "myapp"
        IMAGE_TAG       = "latest"  // or use CI build number/GIT_COMMIT for versioning
        GCR_REGION      = "us"
        GCR_IMAGE       = "${GCR_REGION}.gcr.io/${GCP_PROJECT}/${IMAGE_NAME}:${IMAGE_TAG}"
    }

    stages {

        stage('Authenticate to GCP') {
            steps {
                withCredentials([file(credentialsId: 'my-global-sa', variable: 'GCP_KEY')]) {
                    sh '''
                        gcloud auth activate-service-account --key-file=$GCP_KEY
                        gcloud config set project ${GCP_PROJECT}
                        gcloud auth configure-docker --quiet
                    '''
                }
            }
        }

        stage('Get GKE Credentials') {
            steps {
                sh """
                  gcloud container clusters get-credentials ${GKE_CLUSTER} \
                  --region ${GKE_REGION}
                """
            }
        }

       
        stage('Deploy/Update Deployment + Service') {
            steps {
                sh """
                    # Apply Service & Deployment YAML in case anything changed
                    kubectl apply -f ${DEPLOYMENT_FILE}

                    # Update Deployment with the latest image from CI
                    kubectl set image deployment/admin-deployment \
                        admin-container=${GCR_IMAGE}

                    # Wait for the rollout to complete
                    kubectl rollout status deployment/admin-deployment --timeout=180s
                """
            }
        }

    } // end of stages

    post {
        success {
            echo "✅ Production deployment successful: ${GCR_IMAGE}"
        }
        failure {
            echo "❌ Production deployment failed! Check logs and rollback if necessary."
        }
    }

} // end of pipeline

