pipeline {
    agent { label 'jenkins-agent' }  // same agent as CI

    environment {
        GCP_PROJECT = "prod-project-477306"
        GKE_CLUSTER = "gke-standard-cluster"
        GKE_REGION  = "us-central1-a"
        DEPLOYMENT_FILE = "k8s/admin-deployment-service.yaml"
        INGRESS_FILE = "k8s/admin-ingress.yaml"   // <- set to actual file
    }

    stages {

        stage('Checkout Code') {
            steps {
                git branch: 'main', url: 'https://github.com/abhizarkar7551/dev.git'
            }
        }

        stage('Authenticate to GCP') {
            steps {
                withCredentials([file(credentialsId: 'my-global-sa', variable: 'GCP_KEY')]) {
                    sh '''
                      gcloud auth activate-service-account --key-file=$GCP_KEY
                      gcloud config set project ${GCP_PROJECT}
                    '''
                }
            }
        }

        stage('Get GKE Credentials') {
            steps {
                sh """
                  gcloud container clusters get-credentials ${GKE_CLUSTER} \
                  --region ${GKE_REGION}
                """
            }
        }

        stage('Deploy Deployment + Service') {
            steps {
                sh """
                  kubectl apply -f ${DEPLOYMENT_FILE}
                  kubectl rollout status deployment/admin-deployment --timeout=120s
                """
            }
        }

    } // <-- end of stages

    post {
        success {
            echo "✅ Deployment and Ingress applied successfully!"
        }
        failure {
            echo "❌ Deployment failed! Check logs."
        }
    }

} // <-- end of pipeline
